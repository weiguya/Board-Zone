<script>
  const socket = io();

  // ดึงข้อมูลจาก Local Storage
  const roomName = localStorage.getItem('roomName');
  const playerName = localStorage.getItem('playerName');

  if (!roomName || !playerName) {
    alert('Room or player information is missing!');
    window.location.href = '/';
  }

  // แสดงชื่อห้อง
  document.getElementById('roomName').textContent = `Room: ${roomName}`;

  // ส่งคำขอเข้าร่วมห้องไปยังเซิร์ฟเวอร์
  socket.emit('request join', { roomName, playerName });

  // อัปเดตรายชื่อผู้เล่นและข้อความแชท
  socket.on('room updated', ({ players, messages }) => {
    // อัปเดตรายชื่อผู้เล่น
    const playerList = document.getElementById('playerList');
    playerList.innerHTML = '';
    players.forEach((player) => {
      const li = document.createElement('li');
      li.textContent = player.name;
      playerList.appendChild(li);
    });

    // แสดงปุ่มเริ่มเกมเฉพาะเจ้าของห้อง
    const startGameButton = document.getElementById('startGameButton');
    startGameButton.style.display = players[0]?.id === socket.id ? 'block' : 'none';

    // อัปเดตข้อความแชท
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = '';
    messages.forEach(({ playerName, message }) => {
      const p = document.createElement('p');
      p.textContent = `${playerName}: ${message}`;
      chatMessages.appendChild(p);
    });

    // เลื่อนกล่องข้อความแชทอัตโนมัติ
    chatMessages.scrollTop = chatMessages.scrollHeight;
  });

  // ส่งข้อความแชท
  document.getElementById('chatForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const message = document.getElementById('chatInput').value.trim();
    if (message) {
      socket.emit('chat message', { roomName, playerName, message });
      document.getElementById('chatInput').value = '';
    }
  });

  // รับข้อความแชทใหม่
  socket.on('chat message', ({ playerName, message }) => {
    console.log('New chat message received:', playerName, message);

    const chatMessages = document.getElementById('chatMessages');
    const p = document.createElement('p');
    p.textContent = `${playerName}: ${message}`;
    chatMessages.appendChild(p);

    // เลื่อนกล่องข้อความแชทให้อยู่ด้านล่างสุด
    chatMessages.scrollTop = chatMessages.scrollHeight;
  });

  // เมื่อเจ้าของห้องกดเริ่มเกม
  document.getElementById('startGameButton').addEventListener('click', () => {
    socket.emit('start game', { roomName });
  });

  // ฟังเหตุการณ์เริ่มเกม
  socket.on('game started', ({ game }) => {
    alert(`Game "${game}" started!`);
    // เปลี่ยนหน้าไปยังหน้าของเกม
  });

  // ฟังข้อผิดพลาดจากเซิร์ฟเวอร์
  socket.on('error', ({ message }) => {
    alert(message);
  });
</script>
